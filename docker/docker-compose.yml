version: '3.8'

services:
  rn2:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: rn2:latest
    container_name: rn2
    restart: unless-stopped
    
    # RTL-SDR USB device passthrough
    # Privileged mode required for USB access and rtl_biast
    privileged: true
    devices:
      - /dev/bus/usb:/dev/bus/usb
    
    environment:
      - TZ=Europe/London
      - NOAA_HOME=/opt/raspberry-noaa-v2
    
    volumes:
      # Persistent data - all stored on NAS to survive SD card replacement
      # Images stored on NAS
      - /home/pi/nas/wrx-images:/srv/images
      # Videos stored on NAS
      - /home/pi/nas/wrx-videos:/srv/videos
      # Audio stored on NAS (includes baseband recordings)
      - /home/pi/nas/wrx-audio:/srv/audio
      
      # Database - persistent named volume (on SD card, but small and can be recreated)
      - rn2-db:/opt/raspberry-noaa-v2/db
      
      # Configuration - stored on NAS for easy editing and backup
      - /home/pi/nas/wrx-config/settings.yml:/opt/raspberry-noaa-v2/config/settings.yml:ro
      
      # Logs - persistent named volume (on SD card, but can be recreated)
      - rn2-logs:/var/log/raspberry-noaa-v2
      
      # At jobs spool (for scheduled captures) - persistent
      - rn2-at-spool:/var/spool/cron/atjobs
    
    # Internal port - Traefik handles external routing
    expose:
      - "8080"
    
    # Also expose locally for direct access during testing
    ports:
      - "127.0.0.1:8180:8080"
    
    networks:
      - traefik
      - default
    
    labels:
      # Traefik integration
      - "traefik.enable=true"
      - "traefik.http.routers.rn2.rule=Host(`wrx.liveencode.com`)"
      - "traefik.http.routers.rn2.entrypoints=websecure"
      - "traefik.http.routers.rn2.tls.certresolver=letsencrypt"
      - "traefik.http.routers.rn2.middlewares=security-headers@file"
      - "traefik.http.services.rn2.loadbalancer.server.port=8080"
      - "traefik.docker.network=traefik"
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  rn2-db:
    driver: local
  rn2-logs:
    driver: local
  rn2-at-spool:
    driver: local

networks:
  traefik:
    external: true
